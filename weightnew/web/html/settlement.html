<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>结算</title>
    <script type="text/javascript" src="../js/jquery-3.3.1.js"></script>
    <script type="text/javascript">
        function getproducts() {
            try {
                let url = "http://192.168.43.178:5000/getproducts";
                $.getJSON({
                    url: url,
                    data: {},
                    success: updata_table,
                    fail: function () {
                        alert("请求失败！");
                    }
                });
            } catch (e) {
                alert(e);
            }
        }

        function updata_table(data) {
            var products_table = document.getElementById("products_table");
            var product_total_table = document.getElementById("product_total_table");
            var product_table_html;
            var product_total_html;
            product_table_html = "<tr>" +
                "<th>中药名称</th>" +
                "<th>中药重量</th>" +
                "<th>中药单价</th>" +
                "<th>小计</th>" +
                "</tr>";
            product_total_html = "<tr>" +
                "<th>中药种类</th>" +
                "<th>中药总重</th>" +
                "<th>总价</th>" +
                "</tr>";
            var products_count = 0;
            var total_price = 0;
            for (var i = 0; i < data.length; i++) {
                var subtotal = data[i]["unit_price"] * data[i]["products_count"];
                products_count += data[i]["products_count"];
                total_price += subtotal;
                var tr1 = "<tr>" +
                    `<th>${data[i]["name"]}</th>` +
                    `<th>${data[i]["products_count"]}g</th>` +
                    `<th>¥${data[i]["unit_price"]}/g</th>` +
                    `<th>¥${parseFloat(subtotal).toFixed(2)}</th>` +
                    "</tr>";
                product_table_html += tr1;
            }
            products_table.innerHTML = product_table_html;
            product_total_html += "<tr>" +
                `<th>${data.length}</th>` +
                `<th>${parseFloat(products_count).toFixed(2)}g</th>` +
                `<th>¥${parseFloat(total_price).toFixed(2)}</th>` +
                "</tr>";
            product_total_table.innerHTML = product_total_html;
        }

        window.onload = function () { //在页面初始化的时候调用
            console.log("页面的加载函数");
            getproducts();//加载最后的购物信息
        }
    </script>
</head>
<body>

<div align="center">
    <h1>
        <font color="black"/>
        采购药材清单
    </h1>
</div>
<div align="center">
    <font color="black"/>
    <table id="products_table" border="1" rules="all" cellpadding="10">
        <tr>
            <th>中药名称</th>
            <th>中药重量</th>
            <th>中药单价</th>
            <th>小计</th>
        </tr>
    </table>
    <br>
    <table id="product_total_table" align="" border="1" rules="all" cellpadding="10">
        <tr>
            <th>中药种类</th>
            <th>中药总重</th>
            <th>合计</th>
        </tr>
    </table>
</div>
<div align="center">
    <h3>
        <font color="#a52a2a"/>
        请取走你的所有药材，注意不要遗漏！
    </h3>
</div>
</body>
</html>
